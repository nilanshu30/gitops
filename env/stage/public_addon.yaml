services:
  # PostgreSQL Database
  postgres:
    image: postgres:15.10
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root
      - POSTGRES_DB=brobazaar
    networks:
      - public

  # Elasticsearch
  elasticsearch:
      image: elasticsearch:8.17.1
      environment:
        - discovery.type=single-node
        - "ES_JAVA_OPTS=-Xms1024m -Xmx1024m"
        - bootstrap.memory_lock=true
      ulimits:
        memlock:
          soft: -1
          hard: -1
      networks:
        - public
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.elasticsearch.rule=Host(`es.nilanshu.xyz`)"
        - "traefik.http.services.elasticsearch.loadbalancer.server.port=9200"
        - "traefik.http.routers.elasticsearch.entrypoints=web"

  # Redis for Celery
  redis:
    image: redis:7.4.2
    networks:
      - public

  # Shlink (URL Shortener)
  shlink:
    image: shlinkio/shlink:4.4-roadrunner
    depends_on:
      - postgres
    environment:
      - DEFAULT_DOMAIN=http://short.nilanshu.xyz
      - DB_DRIVER=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=root
      - DB_PASSWORD=root
      - DB_NAME=mydatabase
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.shlink.loadbalancer.server.port=8080"
    networks:
      - public

  # Shlink Web Client
  shlink_web:
    image: shlinkio/shlink-web-client:stable
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink_web.rule=Host(`short.nilanshu.xyz`)"
      - "traefik.http.services.shlink_web.loadbalancer.server.port=80"
      - "traefik.http.routers.shlink_web.entrypoints=web"
    networks:
      - public

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink_web.rule=Host(`crm.nilanshu.xyz`)"
      - "traefik.http.services.shlink_web.loadbalancer.server.port=80"
      - "traefik.http.routers.shlink_web.entrypoints=web"
    networks:
      - public

networks:
  public:
    external: true
